<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../behaviors/toarray-behavior.html">
<link rel="import" href="../behaviors/resources-behavior.html">
<link rel="import" href="redux.html">

<dom-module id="fp-categories-store">
  <template>
    <iron-ajax id="categoriesSource"
      url="[[apiUrls.getCategories]]"
      handle-as="json"
      on-last-response-changed="_storeCategories"></iron-ajax>
  </template>
  <script>

    (function () {
      var categories = Redux.createStore(function(state, action) {
        if(!state) return {
          isLoading: false,
          items: []
        };

        switch(action.type) {
          case 'load-categories':
            return Object.assign({}, state, {
              isLoading: true
            });
            break;
          case 'categories-loaded':
            return Object.assign({}, state, {
              isLoading: false,
              items: action.data
            });
            break;
          default:
            return state;
        }
      });

      Polymer({

        is: 'fp-categories-store',
        behaviors: [toarrayBehavior, resourcesBehavior, PolymerRedux(categories)],
        properties: {
          response: Object,
          categories: {
            type: Array,
            notify: true,
            readOnly: true,
            statePath: 'items'
          },
        },

        actions: {
          loadCategories: function() {
            return {
              type: 'load-categories'
            }
          },
          categoriesLoaded: function(data) {
            return {
              type: 'categories-loaded',
              data: data
            }
          }
        },

        ready: function () {
          if (this.getState().items.length === 0 && !this.getState().isLoading) {
            this.dispatch('loadCategories');
            this.$.categoriesSource.generateRequest();
          }
        },

        _storeCategories: function(e) {
          this.dispatch('categoriesLoaded', this._toArray(e.detail.value));
        },

        _computeCategories: function() {
          return categories;
        }
      });
    })();
  </script>
</dom-module>
