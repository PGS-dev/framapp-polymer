<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../behaviors/toarray-behavior.html">
<link rel="import" href="../behaviors/resources-behavior.html">
<link rel="import" href="../../bower_components/polymer-redux/polymer-redux.html">
<link rel="import" href="redux.html">

<dom-module id="fp-products-store">
  <template>
    <iron-ajax id="productsSource"
               url="[[apiUrls.getProducts]]"
               handle-as="json"
               on-last-response-changed="_storeProducts"></iron-ajax>
  </template>
  <script>
    (function() {
      var products = Redux.createStore(function(state, action) {
        if(!state) return {
          isLoading: false,
          items: []
        };

        switch(action.type) {
          case 'load-products':
            return Object.assign({}, state, {
              isLoading: true
            });
            break;
          case 'products-loaded':
            return Object.assign({}, state, {
              isLoading: false,
              items: action.data
            });
            break;
          default:
            return state;
        }
      });

      var ReduxBehavior = PolymerRedux(products);

      Polymer({

        is: 'fp-products-store',
        behaviors: [toarrayBehavior, resourcesBehavior, ReduxBehavior],
        properties: {
          category: {
            type: Object,
            value: {}
          },
          promotedOnly: {
            type: Boolean,
            value: false
          },
          allProducts: {
            notify: true,
            readOnly: true,
            statePath: 'items'
          },
          products: {
            notify: true,
            computed: '_computeProducts(allProducts, category, promotedOnly)'
          }
        },

        actions: {
          loadProducts: function() {
            return {
              type: 'load-products'
            }
          },
          productsLoaded: function(data) {
            return {
              type: 'products-loaded',
              data: data
            }
          }
        },

        ready: function () {
          if (this.getState().items.length === 0 && !this.getState().isLoading) {
            this.dispatch('loadProducts');
            this.$.productsSource.generateRequest();
          }
        },
        _storeProducts: function (e) {
          this.dispatch('productsLoaded', this._toArray(e.detail.value));
        },
        _computeProducts: function (products, category, promotedOnly) {
          var filters = [];

          if (promotedOnly) {
            filters.push(_filterByPromoted);
          }

          if (category) {
            filters.push(_filterByCategory);
          }

          return (products || []).filter(applyFilters(filters), this);
        }
      });

      function applyFilters(filters) {
        return function() {
          for(var i = 0; i < filters.length; i++) {
            if(filters[i].apply(this, arguments) === false){
              return false;
            }
          }

          return true;
        };
      }

      function _filterByCategory(element, index, array){
        return !this.category.id || element.category === this.category.id;
      }

      function _filterByPromoted(element) {
        return element.promoted;
      }
    })();
  </script>
</dom-module>
